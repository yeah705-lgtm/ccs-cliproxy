services:
  ccproxy-api:
    # Source code is expected in ./ccproxy-api (see README)
    build:
      context: ./ccproxy-api
      dockerfile: Dockerfile
    container_name: ccproxy-api
    ports:
      - "8000:8000"
      - "1455:1455"  # OAuth callback port for Codex/Claude
    environment:
      - SERVER__HOST=0.0.0.0
      - SERVER__PORT=8000
      - LOGGING__LEVEL=${LOGGING__LEVEL:-INFO}
      - LOGGING__FORMAT=${LOGGING__FORMAT:-json}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - SECURITY__AUTH_TOKEN=${SECURITY__AUTH_TOKEN}
    env_file:
      - .env
    volumes:
      # One host directory (./inject_dir) with multiple subdirectory mounts.
      # IMPORTANT: CCS/CLIProxy expects state under /home/node (not /root).
      - ./inject_dir/ccs:/home/node/.ccs
      - ./inject_dir/claude:/home/node/.claude
      - ./inject_dir/opencode:/home/node/.opencode
      - ./inject_dir/grok:/home/node/.grok-cli
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
